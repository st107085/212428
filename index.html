<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‡¹ğŸ‡¼ å°ç£åœ°éœ‡æ©Ÿç‡åˆ†æå„€</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="./taiwan_counties.geojson.js"></script> 

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #cc0000; border-bottom: 3px solid #eee; padding-bottom: 10px; }
        #map { height: 600px; width: 100%; border-radius: 6px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .user-info { font-weight: bold; color: #007bff; }
        .update-link { 
            background-color: #007bff; color: white; border: none; padding: 10px 20px; 
            border-radius: 5px; cursor: pointer; transition: background-color 0.3s; 
            text-decoration: none; display: inline-block; text-align: center; 
        }
        .update-link:hover { background-color: #0056b3; }
        .disclaimer { border: 2px solid #ffc107; background-color: #fff3cd; color: #856404; padding: 15px; margin-bottom: 20px; border-radius: 5px; font-size: 0.9em; }
        .info-box { background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-top: 15px; font-size: 0.9em; }
        .history-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        .history-list li { padding: 5px 0; border-bottom: 1px dashed #eee; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="disclaimer">
            <h3>âš ï¸ å…è²¬è²æ˜ (Disclaimer)</h3>
            <p id="disclaimer-text">è¼‰å…¥ä¸­...</p>
        </div>

        <h1>å°ç£åœ°éœ‡æ©Ÿç‡åˆ†æå„€ - éœ‡åº¦ â‰¥ 5å¼± (ç¯„ä¾‹)</h1>

        <div class="header-controls">
            <div id="auth-status">
                <button id="google-login-btn">ä½¿ç”¨ Google ç™»å…¥</button>
            </div>
            
            <div id="update-info">
                <p>æ•¸æ“šç”±ç³»çµ±æ’ç¨‹è‡ªå‹•æ›´æ–°ã€‚è‹¥éœ€æ‰‹å‹•å¼·åˆ¶æ›´æ–°ï¼Œè«‹ç™»å…¥å¾Œå‰å¾€ GitHub Actions é é¢è§¸ç™¼ã€‚</p>
            </div>
        </div>

        <div id="map"></div>
        
        <div class="info-box">
            <p>æœ€å¾Œæ›´æ–°æ™‚é–“: <span id="last-update-time">N/A</span></p>
            <p>åˆ†æåŸ·è¡Œè€…: <span id="updater-name">N/A</span></p>
            <p>é¡¯ç¤ºéœ‡åº¦: 
                <select id="shindo-select">
                    <option value="5å¼±">5å¼±</option>
                    <option value="5å¼·">5å¼·</option>
                    <option value="6å¼±">6å¼±</option>
                    <option value="6å¼·">6å¼·</option>
                    <option value="7">7</option>
                </select>
                é æ¸¬å€é–“: 
                <select id="period-select">
                    <option value="1yr">1 å¹´å…§</option>
                    <option value="3yr">3 å¹´å…§</option>
                    <option value="6yr">6 å¹´å…§</option>
                    <option value="9yr">9 å¹´å…§</option>
                </select>
            </p>
        </div>
        
        <h3>ğŸ“ æ›´æ–°æ­·å²ç´€éŒ„ (è¿‘ 10 ç­†)</h3>
        <ul id="history-list" class="history-list">
            <li>è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹æ­·å²ç´€éŒ„ã€‚</li>
        </ul>

    </div>

    <script>
        // *** å¡«å¯«ä½ çš„ Firebase SDK è¨­å®š ***
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN", 
            projectId: "YOUR_PROJECT_ID", 
            // ... (å¡«å¯«å…¶ä»–é…ç½®ï¼Œä¾‹å¦‚ storageBucket, appId)
        };
        // *** å¡«å¯«ä½ çš„ GitHub å„²å­˜åº«è·¯å¾‘ï¼Œç”¨æ–¼æ‰‹å‹•è§¸ç™¼ Actions ***
        // æ ¼å¼: https://github.com/USERNAME/REPO_NAME/actions/workflows/scheduled_analysis.yml
        const GITHUB_ACTIONS_URL = "YOUR_GITHUB_REPO_PATH/actions/workflows/scheduled_analysis.yml";


        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        const authStatusEl = document.getElementById('auth-status');
        const updateInfoEl = document.getElementById('update-info');
        const lastUpdateTimeEl = document.getElementById('last-update-time');
        const updaterNameEl = document.getElementById('updater-name');
        const historyListEl = document.getElementById('history-list');
        const shindoSelect = document.getElementById('shindo-select');
        const periodSelect = document.getElementById('period-select');
        
        let map;
        let geojsonLayer;
        let latestAnalysisData = {}; 

        // --- åœ°åœ–ç›¸é—œå‡½å¼ ---

        function getColor(probability) {
            return probability > 75 ? '#800026' :
                   probability > 50  ? '#BD0026' :
                   probability > 30  ? '#E31A1C' :
                   probability > 10  ? '#FC4E2A' :
                   probability > 5   ? '#FD8D3C' :
                   probability > 1   ? '#FEB24C' :
                                       '#FFEDA0';
        }

        function style(feature) {
            const shindo = shindoSelect.value;
            const period = periodSelect.value;
            // ç¸£å¸‚åç¨±æ¨™æº–åŒ– (å°‡è‡ºè½‰ç‚ºå°)
            const countyName = feature.properties.COUNTYNAME ? feature.properties.COUNTYNAME.replace('è‡º','å°') : ''; 
            
            const probability = latestAnalysisData[countyName] 
                && latestAnalysisData[countyName][shindo] 
                && latestAnalysisData[countyName][shindo][period] 
                ? latestAnalysisData[countyName][shindo][period] : 0;

            return {
                fillColor: getColor(probability),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        function plotResultsOnMap() {
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }
            
            function onEachFeature(feature, layer) {
                const shindo = shindoSelect.value;
                const period = periodSelect.value;
                const countyName = feature.properties.COUNTYNAME ? feature.properties.COUNTYNAME.replace('è‡º','å°') : 'N/A';
                
                const probability = latestAnalysisData[countyName] 
                    && latestAnalysisData[countyName][shindo] 
                    && latestAnalysisData[countyName][shindo][period] 
                    ? latestAnalysisData[countyName][shindo][period] : 'N/A';
                
                let tooltipContent = `<b>${feature.properties.COUNTYNAME || 'æœªçŸ¥ç¸£å¸‚'}</b><br>
                                      éœ‡åº¦ ${shindo}ï¼š<br>
                                      ${period} å…§ç™¼ç”Ÿæ©Ÿç‡: <b>${probability}%</b>`;

                layer.bindTooltip(tooltipContent, { permanent: false, direction: 'auto' });
            }

            if (window.taiwanCountiesGeoJSON) {
                geojsonLayer = L.geoJSON(window.taiwanCountiesGeoJSON, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);

                map.fitBounds(geojsonLayer.getBounds());
            } 
        }

        function initMap() {
            map = L.map('map').setView([23.6, 120.9], 8); 
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            plotResultsOnMap();
        }

        // --- Firebase æ•¸æ“šè®€å–èˆ‡é¡¯ç¤º ---

        async function fetchLatestAnalysis() {
            // åªæœ‰ç™»å…¥å¾Œæ‰èƒ½è®€å– Firestore (ä¾ç…§ä½ çš„è¦å‰‡è¨­å®š)
            if (!auth.currentUser) {
                lastUpdateTimeEl.textContent = 'è«‹å…ˆç™»å…¥';
                updaterNameEl.textContent = 'è«‹å…ˆç™»å…¥';
                document.getElementById('disclaimer-text').textContent = 'è«‹å…ˆç™»å…¥ä»¥è®€å–æœ€æ–°çš„åˆ†æçµæœå’Œå…è²¬è²æ˜ã€‚';
                return; 
            }

            try {
                const doc = await db.collection('analysis_results').doc('latest').get();
                if (doc.exists) {
                    const data = doc.data();
                    
                    latestAnalysisData = data.analysisData || {};
                    
                    lastUpdateTimeEl.textContent = data.updateTime.toDate().toLocaleString();
                    updaterNameEl.textContent = data.updaterName;
                    document.getElementById('disclaimer-text').textContent = data.disclaimer;
                    
                    plotResultsOnMap();
                } else {
                    lastUpdateTimeEl.textContent = 'ç„¡è³‡æ–™';
                    updaterNameEl.textContent = 'ç„¡è³‡æ–™';
                }
            } catch (error) {
                console.error("è®€å–åˆ†æçµæœå¤±æ•— (å¯èƒ½æ˜¯æ¬Šé™å•é¡Œ):", error);
                document.getElementById('disclaimer-text').textContent = 'è®€å–æ•¸æ“šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç™»å…¥ç‹€æ…‹æˆ– Firestore æ¬Šé™ã€‚';
            }
        }
        
        async function fetchUpdateHistory() {
             if (!auth.currentUser) {
                historyListEl.innerHTML = '<li>è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹æ­·å²ç´€éŒ„ã€‚</li>';
                return;
            }
            try {
                const snapshot = await db.collection('update_history')
                    .orderBy('updateTime', 'desc')
                    .limit(10) 
                    .get();

                historyListEl.innerHTML = '';
                if (snapshot.empty) {
                    historyListEl.innerHTML = '<li>ç›®å‰æ²’æœ‰æ›´æ–°ç´€éŒ„ã€‚</li>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const timeStr = data.updateTime.toDate().toLocaleString();
                    const statusText = data.status.startsWith('SUCCESS') ? 'æˆåŠŸ' : 'å¤±æ•—';
                    const statusColor = data.status.startsWith('SUCCESS') ? 'green' : 'red';
                    
                    const li = document.createElement('li');
                    li.innerHTML = `<span style="color: ${statusColor};">[${statusText}]</span> ${timeStr} ç”± <b>${data.updaterName}</b> åŸ·è¡Œ`;
                    historyListEl.appendChild(li);
                });

            } catch (error) {
                console.error("è®€å–æ­·å²ç´€éŒ„å¤±æ•—:", error);
                historyListEl.innerHTML = '<li>è®€å–æ­·å²ç´€éŒ„å¤±æ•—ã€‚</li>';
            }
        }

        // --- ç™»å…¥/ç™»å‡ºè™•ç† ---

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(error => alert(`ç™»å…¥å¤±æ•—: ${error.message}`));
        }

        auth.onAuthStateChanged(user => {
            // ç™»å…¥ç‹€æ…‹è®ŠåŒ–æ™‚ï¼Œé‡æ–°è®€å–æ‰€æœ‰æ•¸æ“š
            fetchLatestAnalysis();
            fetchUpdateHistory();

            if (user) {
                // å·²ç™»å…¥
                authStatusEl.innerHTML = `
                    <p class="user-info">
                        ä½ å¥½ï¼Œ${user.displayName || user.email}ï¼ 
                        <button id="google-logout-btn">ç™»å‡º</button>
                    </p>
                `;
                document.getElementById('google-logout-btn').addEventListener('click', () => auth.signOut());
                
                // é¡¯ç¤ºæ‰‹å‹•æ›´æ–°çš„å…¥å£
                updateInfoEl.innerHTML = `
                    <p>æ•¸æ“šç”±ç³»çµ±æ’ç¨‹è‡ªå‹•æ›´æ–°ï¼Œä¸Šæ¬¡æ›´æ–°è€…ç‚º <b>${updaterNameEl.textContent}</b>ã€‚</p>
                    <a href="${GITHUB_ACTIONS_URL}" target="_blank" class="update-link">
                        æ‰‹å‹•è§¸ç™¼ç³»çµ±æ›´æ–° (è¨˜éŒ„ç‚º GitHub å¸³è™Ÿè²¢ç»)
                    </a>
                `;
            } else {
                // æœªç™»å…¥
                authStatusEl.innerHTML = `<button id="google-login-btn">ä½¿ç”¨ Google ç™»å…¥</button>`;
                document.getElementById('google-login-btn').addEventListener('click', signInWithGoogle);
                
                // æœªç™»å…¥ç‹€æ…‹ï¼Œé¡¯ç¤ºä¸€èˆ¬æç¤º
                updateInfoEl.innerHTML = `
                    <p>è«‹ç™»å…¥ä»¥å–å¾—è®€å–æ¬Šé™ä¸¦æŸ¥çœ‹æ‰‹å‹•æ›´æ–°å…¥å£ã€‚</p>
                `;
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            
            shindoSelect.addEventListener('change', plotResultsOnMap);
            periodSelect.addEventListener('change', plotResultsOnMap);
        });
    </script>
</body>
</html>
